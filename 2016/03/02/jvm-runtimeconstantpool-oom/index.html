<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>测试JVM运行时常量池溢出 | Hunter的博客</title>
  <meta name="author" content="Hunter Lin">
  
  <meta name="description" content="Hunter的博客-努力工作，幸福生活">
  
  <meta name="keywords" content="java,jvm">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="测试JVM运行时常量池溢出"/>
  <meta property="og:site_name" content="Hunter的博客"/>

  
  <meta property="og:image" content="undefined"/>
  
  
  <!-- 百度验证 -->
  
  <meta name="baidu-site-verification" content="xyDHnOQvLc" />
  

  <!-- google验证 -->
  
  <meta name="google-site-verification" content="XetGPCVQcMEMmGykIpHKZTAIQzRX1uLgL5FrmjoMXSE" />
  

  <!-- sogou验证 -->
  
  <meta name="sogou_site_verification" content="xA7xdyVjJV" />
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Hunter的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- 使用google代码高亮 -->
  
  <!--
  <link rel="stylesheet" href="/plugins/google-code-prettify/prettify.css" type="text/css">
  -->
  <!--
  <link rel="stylesheet" href="/plugins/google-code-prettify/vibrant-ink.css" type="text/css">
  -->
  <link rel="stylesheet" href="/plugins/google-code-prettify/tomorrow-night.css" type="text/css"> 
  

  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  

  <style type="text/css">
  pre{
    word-wrap:break-word;
    word-break:break-all;
  }
  ol.linenums{
    /*代码行数颜色*/
    color:#CCC !important;
    font-size:14px !important;
  }
  </style>
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Hunter的博客</a></h1>
  <h2><a href="/">努力工作，幸福生活</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
      <li><a href="/book">Book</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-02T02:26:28.000Z"><a href="/2016/03/02/jvm-runtimeconstantpool-oom/">2016-03-02</a></time>
      
      
  
    <h1 class="title">测试JVM运行时常量池溢出</h1>
  

    </header>
    <div class="entry">
      
        <p>运行时常量池属于方法区(俗称永久代)，如果要使运行时常量池溢出其实就是使方法区溢出，可以通过调整方法区的大小并配合String.intern方法来实现。<br><a id="more"></a></p>
<h2 id="Java代码"><a href="#Java代码" class="headerlink" title="Java代码"></a><strong>Java代码</strong></h2><pre><code class="java">/**
 * VM Args: -XX:PermSize=10m -XX:MaxPermSize=10m
 */
public class RuntimeConstantPoolOOM {
    public static void main(String[] args) {
        List&lt;String&gt; list = new ArrayList&lt;String&gt;();
        int i =1;
        while(true){
            list.add(String.valueOf(i++).intern());
        }
    }
}
</code></pre>
<p>上面代码设置方法区的初始内存和最大内存为10m，并通过intern方法不停往方法区写入数据。</p>
<p>最后运行的结果如自己所预料的那样，出现方法区溢出<br><img src="http://7xqlat.com1.z0.glb.clouddn.com/oom_permgen_space_01.png" alt="方法区溢出"></p>
<p>不过，大家请仔细看，上面是基于jdk1.6运行的结果，我们切换到jdk1.7运行再看看，发现不会出现方法区溢出，这是为什么呢？</p>
<p>查看jdk1.7发布<a href="http://www.oracle.com/technetwork/java/javase/jdk7-relnotes-418459.html" target="_blank" rel="external">notes</a>发现：</p>
<blockquote>
<p>Area: HotSpot<br>Synopsis: In JDK 7, interned strings are no longer allocated in the permanent generation of the Java heap, but are instead allocated in the main part of the Java heap (known as the young and old generations), along with the other objects created by the application. This change will result in more data residing in the main Java heap, and less data in the permanent generation, and thus may require heap sizes to be adjusted. Most applications will see only relatively small differences in heap usage due to this change, but larger applications that load many classes or make heavy use of the String.intern() method will see more significant differences.<br>RFE: 6962931</p>
</blockquote>
<p>在JDK7中，常量池已经从方法区中迁移到了java堆中。</p>
<p>为了验证这个问题，我们调整VM的堆内存大小<code>-Xms10m -Xmx10m</code>再运行，结果如下<br><img src="http://7xqlat.com1.z0.glb.clouddn.com/oom_jav_heap_space_01.png" alt="java堆溢出"></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/技术/">技术</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/JVM/">JVM</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
    
    
    <!--
    <a class="addthis_counter addthis_pill_style"></a>
    -->

    <!-- 加入多说分享 -->
    
      <div class="ds-share flat" data-thread-key="2016/03/02/jvm-runtimeconstantpool-oom/" data-title="Hunter的博客-测试JVM运行时常量池溢出" data-images="此处请替换为分享时显示的图片的链接地址" data-content="" data-url="http://www.linmuxi.com/2016/03/02/jvm-runtimeconstantpool-oom/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">
      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
    
    <!-- end 加入多说分享 -->
    
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  <!-- 加入多说评论 -->
  
        
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="2016/03/02/jvm-runtimeconstantpool-oom/" data-title="测试JVM运行时常量池溢出" data-url="http://www.linmuxi.com/2016/03/02/jvm-runtimeconstantpool-oom/"></div>
  <!-- 多说评论框 end -->

  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
  var duoshuoQuery = {short_name:"hunterlin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
  <!-- 多说公共JS代码 end -->

      
  
  <!-- end加入多说评论 -->

  

</section>

</div></div>
    <aside id="sidebar" class="alignright"></aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Hunter Lin
  

  <!-- 不蒜子统计 -->
  

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259167020'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1259167020%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

</div>
<div class="clearfix"></div></footer>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>



<!-- fancybox -->

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- 站内搜索 -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','fjox-txyzMTBRyd8dwrn','2.0.0');
</script>


<!-- google分析 -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74187619-1', 'auto');
  ga('send', 'pageview');
</script>


<!-- 添加baidu统计 -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a4f074d0c4eecf056150ecbd92e46f89";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- 代码高亮 -->

<script src="/plugins/google-code-prettify/prettify.js"></script>
<script>
  $(window).load(function(){
    $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
    prettyPrint();
  })
</script>


<!-- 不蒜子统计 -->


<!-- baidu自动推送 -->



<script type="text/javascript">
var duoshuoQuery = {short_name:"hunterlin"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>

</body>

</html>